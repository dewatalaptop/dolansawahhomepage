<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Admin Dashboard - Dolan Sawah</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --primary: #2a9d8f;
      --primary-dark: #21867a;
      --secondary: #264653;
      --accent: #e9c46a;
      --danger: #e76f51;
      --success: #10b981;
      --warning: #f59e0b;
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --sidebar-width: 260px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }

    /* LOGIN SCREEN */
    #login-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      z-index: 9999; display: flex; justify-content: center; align-items: center;
    }
    .login-box {
      background: white; padding: 40px; border-radius: 16px; width: 90%; max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center;
    }
    .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; }
    .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.2s; }

    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width); background: white; border-right: 1px solid var(--border);
      display: flex; flex-direction: column; height: 100vh; transition: 0.3s;
      position: fixed; left: 0; top: 0; z-index: 100;
    }
    .brand { padding: 25px; font-size: 1.25rem; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); }
    .nav-menu { flex: 1; padding: 20px; overflow-y: auto; }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 15px;
      color: var(--text-muted); text-decoration: none; border-radius: 10px;
      margin-bottom: 5px; transition: 0.2s; cursor: pointer; font-weight: 500;
    }
    .nav-item:hover, .nav-item.active { background-color: #f0fdf4; color: var(--primary); }
    .nav-item .badge { margin-left: auto; background: var(--danger); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; }
    
    .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); }
    .btn-logout { width: 100%; padding: 10px; background: #fee2e2; color: #ef4444; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

    /* MAIN CONTENT */
    .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 30px; overflow-y: auto; height: 100vh; display: none; }
    #mobile-toggle { 
        display: none; position: fixed; top: 15px; left: 15px; z-index: 2001;
        background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 8px; cursor: pointer;
    }

    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); box-shadow: 5px 0 25px rgba(0,0,0,0.2); }
      .main-content { margin-left: 0; padding: 80px 20px 20px 20px; }
      #mobile-toggle { display: flex; align-items: center; justify-content: center; } 
    }

    /* STATS & CARDS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 20px; }
    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .stat-info h4 { margin: 0; font-size: 0.85rem; color: var(--text-muted); }
    .stat-info .value { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }

    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .request-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .request-card { background: white; border-radius: 12px; padding: 20px; border-left: 5px solid var(--warning); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .req-actions { display: flex; gap: 10px; margin-top: 15px; }
    .req-actions button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
    .btn-accept { background: var(--success); color: white; }
    .btn-reject { background: #fee2e2; color: var(--danger); }
    .btn-chat { background: #25D366; color: white; }

    .calendar-wrapper { background: white; border-radius: 16px; padding: 20px; border: 1px solid var(--border); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; }
    .cal-day { aspect-ratio: 1; border: 1px solid var(--border); border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; font-weight: 500; }
    .cal-day.today { background: #fff7ed; border-color: var(--warning); color: var(--warning); font-weight: 800; }
    .cal-day.selected { background: var(--primary); color: white; }
    .cal-marker { position: absolute; bottom: 6px; width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

    .reservation-list-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .master-item { padding: 12px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items: center; }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <h2 style="color:var(--primary-dark);"><i class="fas fa-leaf"></i> Admin</h2>
      <p style="color:#666;">Dolan Sawah Dashboard</p>
      <input type="email" id="email" placeholder="Email Admin">
      <input type="password" id="password" placeholder="Password">
      <button onclick="handleLogin()">Masuk Dashboard</button>
    </div>
  </div>

  <button id="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

  <div class="sidebar" id="sidebar">
    <div class="brand"><i class="fas fa-seedling"></i> Dolan Sawah</div>
    <div class="nav-menu">
      <div class="nav-item active" onclick="switchTab('dashboard', this)">
        <i class="fas fa-home"></i> Dashboard
      </div>
      <div class="nav-item" onclick="switchTab('inbox', this)">
        <i class="fas fa-inbox"></i> Permintaan
        <span class="badge" id="sidebar-badge" style="display:none;">0</span>
      </div>
      <div class="nav-item" onclick="switchTab('calendar', this)">
        <i class="far fa-calendar-alt"></i> Kalender
      </div>
      <div class="nav-item" onclick="switchTab('data', this)">
        <i class="fas fa-database"></i> Data Master
      </div>
      <div class="nav-item" onclick="switchTab('analysis', this)">
        <i class="fas fa-chart-pie"></i> Analisis
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <div class="main-content" id="main-content">
    
    <div id="tab-dashboard" class="section active">
      <h2 class="section-title">Overview Hari Ini</h2>
      <p id="date-display" style="color:#666;"></p>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background:#e0f2fe; color:#0284c7;"><i class="fas fa-users"></i></div>
          <div class="stat-info"><h4>Tamu Hari Ini</h4><span class="value" id="stat-today-pax">0</span></div>
        </div>
        <div class="stat-card" style="cursor:pointer;" onclick="switchTab('inbox', document.querySelectorAll('.nav-item')[1])">
          <div class="stat-icon" style="background:#ffedd5; color:#c2410c;"><i class="fas fa-inbox"></i></div>
          <div class="stat-info"><h4>Request Pending</h4><span class="value" id="stat-pending">0</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:#dcfce7; color:#15803d;"><i class="fas fa-calendar-check"></i></div>
          <div class="stat-info"><h4>Reservasi Bulan Ini</h4><span class="value" id="stat-month-total">0</span></div>
        </div>
      </div>
      <div class="calendar-wrapper">
         <h3>Reservasi Terbaru</h3>
         <div id="recent-reservations-list"></div>
      </div>
    </div>

    <div id="tab-inbox" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 class="section-title">Inbox Permintaan</h2>
        <button class="btn-chat" style="padding:10px 20px; border-radius:8px;" onclick="forceRefresh()"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      <div id="inbox-container" class="request-grid"></div>
    </div>

    <div id="tab-calendar" class="section">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 class="section-title">Kalender Reservasi</h2>
        <div>
           <button class="btn-chat" onclick="changeMonth(-1)"><</button>
           <span id="cal-month-year" style="font-weight:700; margin: 0 15px;">...</span>
           <button class="btn-chat" onclick="changeMonth(1)">></button>
        </div>
      </div>
      <div class="calendar-wrapper">
        <div style="display:grid; grid-template-columns: repeat(7,1fr); text-align:center; font-weight:600; color:#888;">
            <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
      </div>
      <div style="margin-top:20px;">
          <h3>Detail: <span id="selected-date-text">Pilih Tanggal</span></h3>
          <div id="day-detail-list"></div>
      </div>
    </div>

    <div id="tab-data" class="section">
       <h2>Kelola Data Master</h2>
       <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
         <div class="calendar-wrapper">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Daftar Menu</h3>
                <button class="btn-accept" style="padding:5px 10px; border-radius:5px;" onclick="addMenu()">+ Tambah</button>
            </div>
            <div id="master-menu-list"></div>
         </div>
         <div class="calendar-wrapper">
            <h3>Daftar Lokasi</h3>
            <div id="master-location-list"></div>
         </div>
       </div>
    </div>

    <div id="tab-analysis" class="section">
      <h2>Analisis Bisnis</h2>
      <div class="calendar-wrapper" style="height: 400px;">
          <canvas id="chartAnalysis"></canvas>
      </div>
    </div>

  </div>

  <script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- STATE MANAGEMENT ---
    let unsubRequests, unsubReservations, unsubMenus, unsubLocations;
    let reservationsCache = [];
    let requestsCache = [];
    let globalMenuPrices = {}; 
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let myChart = null;

    const formatIDR = (n) => new Intl.NumberFormat('id-ID').format(n || 0);
    const getTodayStr = () => new Date().toLocaleDateString('sv-SE');

    // --- AUTH ---
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        initApp();
      } else {
        document.getElementById('login-overlay').style.display = 'flex';
        document.getElementById('main-content').style.display = 'none';
        stopAllListeners();
      }
    });

    async function handleLogin() {
      const e = document.getElementById('email').value;
      const p = document.getElementById('password').value;
      try { await auth.signInWithEmailAndPassword(e, p); } 
      catch (err) { Swal.fire('Error', 'Login gagal: ' + err.message, 'error'); }
    }
    function handleLogout() { auth.signOut(); }

    // --- CORE ---
    function initApp() {
        document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
        stopAllListeners();
        listenMasterData();
        listenRequests();
        listenReservations();
    }

    function stopAllListeners() {
        if(unsubRequests) unsubRequests();
        if(unsubReservations) unsubReservations();
        if(unsubMenus) unsubMenus();
        if(unsubLocations) unsubLocations();
    }

    function forceRefresh() {
        Swal.fire({ title: 'Refreshing...', timer: 800, didOpen: () => Swal.showLoading() });
        initApp();
    }

    function listenMasterData() {
        unsubMenus = db.collection('menus').onSnapshot(snap => {
            const list = document.getElementById('master-menu-list');
            list.innerHTML = ''; globalMenuPrices = {};
            snap.forEach(doc => {
                const data = doc.data();
                globalMenuPrices[doc.id] = data.price || 0;
                list.innerHTML += `<div class="master-item">
                    <span>${doc.id} <b style="color:var(--success)">Rp ${formatIDR(data.price)}</b></span>
                    <i class="fas fa-trash" style="color:var(--danger); cursor:pointer" onclick="deleteDoc('menus', '${doc.id}')"></i>
                </div>`;
            });
        });
        unsubLocations = db.collection('locations').onSnapshot(snap => {
            const list = document.getElementById('master-location-list');
            list.innerHTML = '';
            snap.forEach(doc => {
                list.innerHTML += `<div class="master-item">
                    <span>${doc.data().name} (${doc.data().capacity}pax)</span>
                    <i class="fas fa-trash" style="color:var(--danger); cursor:pointer" onclick="deleteDoc('locations', '${doc.id}')"></i>
                </div>`;
            });
        });
    }

    function listenRequests() {
        unsubRequests = db.collection('reservation_requests').orderBy('createdAt', 'desc').onSnapshot(snap => {
            requestsCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderInbox();
        });
    }

    // --- FUNGSI RENDER INBOX (DIPERBARUI) ---
    function renderInbox() {
        const badge = document.getElementById('sidebar-badge');
        const container = document.getElementById('inbox-container');
        document.getElementById('stat-pending').textContent = requestsCache.length;
        
        if(requestsCache.length > 0) {
            badge.textContent = requestsCache.length; badge.style.display = 'inline-block';
        } else badge.style.display = 'none';

        container.innerHTML = requestsCache.map(r => {
            // 1. Tampilan Menu
            let menuDisplay = '<div style="color:#999; font-style:italic;">Tidak ada menu tambahan</div>';
            if (r.menus && Array.isArray(r.menus) && r.menus.length > 0) {
                menuDisplay = r.menus.map(m => `
                    <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:2px 0;">
                        <span>${m.name}</span>
                        <b>x${m.quantity}</b>
                    </div>
                `).join('');
            }

            // 2. Tampilan Note
            const userNote = r.note || r.catatan || r.pesan || '-';

            return `
            <div class="request-card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div>
                        <b style="font-size:1.1rem; color:var(--secondary);">${r.nama}</b>
                        <div style="font-size:0.85rem; color:var(--primary); margin-top:2px;">
                            <i class="fab fa-whatsapp"></i> ${r.nomorHp || '-'}
                        </div>
                    </div>
                    <span style="background:#f3f4f6; padding:2px 8px; border-radius:4px; font-size:0.75rem; color:#666;">${r.via || 'Web'}</span>
                </div>
                
                <div style="font-size:0.85rem; color:#555; display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                    <div><i class="fas fa-calendar" style="width:16px;"></i> ${r.date}</div>
                    <div><i class="fas fa-clock" style="width:16px;"></i> ${r.jam}</div>
                    <div><i class="fas fa-users" style="width:16px;"></i> ${r.jumlah} Org</div>
                    <div><i class="fas fa-map-marker-alt" style="width:16px;"></i> ${r.tempat}</div>
                </div>

                <div style="background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 15px; font-size: 0.85rem;">
                    <div style="margin-bottom: 10px;">
                        <strong style="color:var(--primary-dark); display:block; margin-bottom:5px; font-size:0.8rem; text-transform:uppercase;">
                            <i class="fas fa-sticky-note"></i> Note:
                        </strong>
                        <div style="background:#fff; padding:6px; border-radius:4px; border:1px solid #eee; color:#333;">
                            "${userNote}"
                        </div>
                    </div>
                    <div>
                        <strong style="color:var(--primary-dark); display:block; margin-bottom:5px; font-size:0.8rem; text-transform:uppercase;">
                            <i class="fas fa-utensils"></i> Menu:
                        </strong>
                        <div style="padding:0 5px;">${menuDisplay}</div>
                    </div>
                </div>

                <div class="req-actions">
                    <button class="btn-chat" onclick="prepareChat('${r.id}')"><i class="fab fa-whatsapp"></i> Chat</button>
                    <button class="btn-reject" onclick="deleteDoc('reservation_requests', '${r.id}')">Tolak</button>
                    <button class="btn-accept" onclick="approveRequest('${r.id}')">Terima</button>
                </div>
            </div>
        `}).join('');
    }

    // --- WHATSAPP MESSAGE FORMAT ---
    function prepareChat(requestId) {
        const r = requestsCache.find(x => x.id === requestId);
        if(!r) return;

        let totalFood = 0; let menuDetails = "";
        if(r.menus && Array.isArray(r.menus)) {
            r.menus.forEach(m => {
                const price = globalMenuPrices[m.name] || 0;
                const sub = price * m.quantity;
                totalFood += sub;
                menuDetails += `- ${m.name} (${m.quantity}x) : Rp ${formatIDR(sub)}\n`;
            });
        }

        const ppn = Math.round(totalFood * 0.1);
        const total = totalFood + ppn;
        const dp = Math.round(total * 0.5);
        const userNote = r.note || r.catatan || r.pesan || '';

        const msg = `Halo Kak *${r.nama}* ðŸ‘‹,\n` +
            `Terima kasih telah melakukan reservasi di *Dolan Sawah*.\n\n` +
            `Berikut detail pesanan Anda:\n` +
            `ðŸ—“ Tanggal: ${r.date}\n` +
            `â° Jam: ${r.jam}\n` +
            `ðŸ‘¥ Jumlah: ${r.jumlah} Orang\n` +
            `ðŸ“ Tempat: ${r.tempat}\n` +
            (userNote ? `ðŸ“ Note: ${userNote}\n` : '') +
            `\n*Rincian Pesanan:*\n${menuDetails || "- Belum ada menu -\n"}\n` +
            `----------------------------------\n` +
            `Subtotal: Rp ${formatIDR(totalFood)}\n` +
            `PPN (10%): Rp ${formatIDR(ppn)}\n` +
            `*Total Tagihan: Rp ${formatIDR(total)}*\n\n` +
            `----------------------------------\n` +
            `Untuk konfirmasi, mohon melakukan pembayaran *DP (50%)* sebesar:\n` +
            `ðŸ‘‰ *Rp ${formatIDR(dp)}*\n\n` +
            `Silakan transfer ke rekening berikut:\n\n` +
            `*Rekening Dolan Sawah*\n\n` +
            `âœ… *BRI* *008101002059562*\n` +
            `a.n *Teofilus Gagah*\n` +
            `Mohon kirimkan bukti transfer ini untuk kami proses approve âœ…. Terima kasih!`;

        let phone = r.nomorHp.replace(/\D/g, '');
        if (phone.startsWith('0')) phone = '62' + phone.slice(1);
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // --- APPROVE LOGIC + AUTO VIEWER ---
    async function approveRequest(id) {
        const r = requestsCache.find(x => x.id === id);
        if(!r) return;

        const { value: form } = await Swal.fire({
            title: 'Setujui Reservasi',
            html: `
                <div style="text-align:left; font-size:0.8rem; color:#888;">Nominal DP:</div>
                <input id="sw-dp" type="number" class="swal2-input" placeholder="Rp">
                <select id="sw-pay" class="swal2-input">
                    <option value="Transfer BRI">Transfer BRI</option>
                    <option value="QRIS">QRIS</option>
                    <option value="Cash">Cash</option>
                </select>`,
            preConfirm: () => {
                const dpVal = document.getElementById('sw-dp').value;
                if(!dpVal || dpVal <= 0) return Swal.showValidationMessage('DP wajib diisi');
                return { dp: parseInt(dpVal), pay: document.getElementById('sw-pay').value };
            }
        });

        if(form) {
            try {
                const data = {...r, status: 'approved', dp: form.dp, tipeDp: form.pay, approvedAt: firebase.firestore.FieldValue.serverTimestamp()};
                delete data.id;
                await db.collection('reservations').add(data);
                await db.collection('reservation_requests').doc(id).delete();
                
                // AUTO OPEN VIEWER
                const viewerUrl = `https://dewatalaptop.github.io/reservasids?autoOpen=true&date=${r.date}&search=${encodeURIComponent(r.nama)}`;
                window.open(viewerUrl, '_blank');
                
                Swal.fire('Berhasil', 'Reservasi tersimpan dan Viewer dibuka.', 'success');
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        }
    }

    // --- KALENDER ---
    function listenReservations() {
        unsubReservations = db.collection('reservations').onSnapshot(snap => {
            reservationsCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderDashboardStats(); renderCalendar(); updateChart();
        });
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
        const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        document.getElementById('cal-month-year').textContent = `${months[currentMonth]} ${currentYear}`;

        let firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const todayStr = getTodayStr();

        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const count = reservationsCache.filter(x => x.date === dateStr).length;
            grid.innerHTML += `<div class="cal-day ${dateStr === todayStr ? 'today' : ''}" onclick="showDateDetail('${dateStr}')">
                ${d}${count > 0 ? '<div class="cal-marker"></div>' : ''}
            </div>`;
        }
    }

    function showDateDetail(date) {
        document.getElementById('selected-date-text').textContent = date;
        const filtered = reservationsCache.filter(x => x.date === date);
        const list = document.getElementById('day-detail-list');
        list.innerHTML = filtered.length ? filtered.map(r => `
            <div class="reservation-list-item">
                <div><b>${r.jam} - ${r.nama}</b><br><small>${r.tempat} (${r.jumlah}pax)</small></div>
                <button class="btn-chat" onclick="window.open('https://wa.me/${r.nomorHp}')">WA</button>
            </div>`).join('') : '<p>Tidak ada reservasi.</p>';
    }

    function changeMonth(dir) {
        currentMonth += dir;
        if(currentMonth < 0) { currentMonth = 11; currentYear--; }
        if(currentMonth > 11) { currentMonth = 0; currentYear++; }
        renderCalendar();
    }

    // --- UI HELPERS ---
    function switchTab(tabId, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('tab-'+tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        if(window.innerWidth < 768) toggleSidebar();
    }

    function renderDashboardStats() {
        const today = getTodayStr();
        const todayPax = reservationsCache.filter(x => x.date === today).reduce((s, x) => s + (parseInt(x.jumlah) || 0), 0);
        document.getElementById('stat-today-pax').textContent = todayPax;
        document.getElementById('stat-month-total').textContent = reservationsCache.filter(x => new Date(x.date).getMonth() === new Date().getMonth()).length;

        const sorted = [...reservationsCache].sort((a,b) => (b.approvedAt?.seconds || 0) - (a.approvedAt?.seconds || 0)).slice(0, 5);
        document.getElementById('recent-reservations-list').innerHTML = sorted.map(r => `
            <div class="reservation-list-item">
                <span><b>${r.nama}</b><br><small>${r.date} | ${r.jam}</small></span>
                <span class="badge" style="background:var(--primary)">${r.jumlah} pax</span>
            </div>`).join('');
    }

    function updateChart() {
        const ctx = document.getElementById('chartAnalysis').getContext('2d');
        const data = Array(12).fill(0);
        reservationsCache.forEach(r => { 
            const d = new Date(r.date); 
            if(d.getFullYear() === currentYear) data[d.getMonth()]++; 
        });
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar', data: { labels: ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"], datasets: [{ label: 'Reservasi', data: data, backgroundColor: '#2a9d8f' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    async function addMenu() {
        const { value: name } = await Swal.fire({ title: 'Nama Menu', input: 'text' });
        if(!name) return;
        const { value: price } = await Swal.fire({ title: 'Harga', input: 'number' });
        if(name && price) {
            await db.collection('menus').doc(name).set({ price: parseInt(price) });
        }
    }

    function deleteDoc(col, id) {
        Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true }).then(res => {
            if(res.isConfirmed) db.collection(col).doc(id).delete();
        });
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Reservasi Dolan Sawah</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* --- CSS UTAMA (Sama seperti sebelumnya) --- */
    :root {
      --primary: #2a9d8f;
      --primary-dark: #264653;
      --secondary: #e9c46a;
      --bg: #f0f2f5;
      --white: #ffffff;
      --text: #333333;
      --dark: #222222;
      --danger: #e74c3c;
      --success: #27ae60;
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding-bottom: 100px;
      color: var(--text);
    }

    /* HEADER */
    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: white;
      padding: 20px 20px 30px 20px;
      text-align: center;
      border-bottom-left-radius: 30px;
      border-bottom-right-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: sticky; top: 0; z-index: 99;
      user-select: none; /* Mencegah blok teks saat klik cepat */
    }
    .dynamic-title { font-size: 1.3rem; font-weight: 700; margin-top: 5px; animation: fadeIn 0.5s; }

    /* STEP INDICATOR */
    .step-indicator { display: flex; justify-content: center; margin-top: 15px; gap: 25px; }
    .step-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; }
    .step-dot { width: 12px; height: 12px; background: rgba(255,255,255,0.4); border-radius: 50%; transition: 0.3s; }
    .step-label { font-size: 0.65rem; color: rgba(255,255,255,0.6); font-weight: 500; }
    .step-wrapper.active .step-dot { background: var(--white); transform: scale(1.2); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    .step-wrapper.active .step-label { color: var(--white); font-weight: 700; }
    .step-wrapper.completed .step-dot { background: var(--secondary); }

    .container { max-width: 600px; margin: -20px auto 0; padding: 0 15px; position: relative; z-index: 100; }

    /* CARD STYLE */
    .card {
      background: var(--white); border-radius: 20px; padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* INPUTS */
    .input-group-custom { position: relative; margin-bottom: 15px; }
    .input-visual {
      display: flex; align-items: center; padding: 15px;
      background: #fff; border: 2px solid #eee; border-radius: 15px;
      transition: 0.3s; cursor: pointer;
    }
    .input-visual:focus-within { border-color: var(--primary); }
    .input-group-custom.error .input-visual { border-color: var(--danger); background: #fff5f5; }
    .error-msg { color: var(--danger); font-size: 0.75rem; margin-top: 5px; display: none; }
    .input-group-custom.error .error-msg { display: block; }
    .input-visual i { font-size: 1.4rem; color: var(--primary); margin-right: 15px; width: 30px; text-align: center; }
    .input-visual .label-text strong { font-size: 1.05rem; color: var(--dark); display:block;}
    .input-visual .label-text span { font-size: 0.75rem; color: #888; }
    .hidden-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0; cursor: pointer; z-index: 10; }

    /* STEPPER QUANTITY */
    .stepper-control {
      display: flex; align-items: center; justify-content: space-between;
      background: #f8f9fa; border-radius: 12px; padding: 5px;
      border: 1px solid #eee;
    }
    .stepper-btn {
      width: 35px; height: 35px; border-radius: 8px; border: none;
      background: var(--white); color: var(--primary); 
      font-size: 1.2rem; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.1s;
      display: flex; align-items: center; justify-content: center;
    }
    .stepper-btn:active { transform: scale(0.9); background: var(--primary); color: white; }
    .stepper-input {
      width: 50px; text-align: center; border: none; background: transparent;
      font-weight: 700; font-size: 1.1rem; color: var(--dark);
      -moz-appearance: textfield; 
    }
    .stepper-input::-webkit-outer-spin-button,
    .stepper-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    /* LOCATION CARDS */
    .location-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .location-option {
      border: 1px solid #eee; border-radius: 15px; overflow: hidden;
      background: white; display: flex; flex-direction: column;
      transition: 0.2s; position: relative;
    }
    .location-option.selected { border: 2px solid var(--primary); box-shadow: 0 10px 20px rgba(42, 157, 143, 0.2); transform: translateY(-3px); }
    .location-option.selected::after {
        content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
        position: absolute; top: 10px; right: 10px; background: var(--primary);
        color: white; width: 25px; height: 25px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center; font-size: 0.8rem; z-index: 5;
    }
    .location-option.disabled { opacity: 0.6; filter: grayscale(100%); pointer-events: none; }
    .loc-thumb-wrapper { width: 100%; height: 100px; background: #eee; position: relative; }
    .loc-thumb-img { width: 100%; height: 100%; object-fit: cover; }
    .loc-content { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; }
    .loc-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 5px; color: var(--dark); line-height: 1.3; }
    .cap-badge { display: inline-block; padding: 4px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-align: center; margin-bottom: 10px; align-self: start; }
    .cap-safe { background: #e8f5e9; color: #27ae60; }
    .cap-full { background: #ffebee; color: #c0392b; }
    
    .btn-loc-view { 
        background: var(--primary); color: white;
        border: none; width: 100%; padding: 10px; 
        border-radius: 10px; font-size: 0.85rem; font-weight: 600; margin-top: auto; cursor: pointer;
        position: relative; z-index: 10; transition: 0.2s;
        display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-loc-view:hover { 
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(42, 157, 143, 0.3);
    }
    .btn-loc-view i { font-size: 1rem; }

    /* MENU ACCORDION */
    .menu-category { margin-bottom: 15px; border: 1px solid #f0f0f0; border-radius: 12px; overflow: hidden; }
    .cat-header {
      background: #fff; padding: 15px; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; color: var(--dark); transition: 0.2s;
    }
    .cat-badge { background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; display: none; margin-left: 8px; }
    .cat-content { display: none; padding: 0 15px; background: white; border-top: 1px solid #f0f0f0; }
    .cat-content.show { display: block; }
    
    .menu-item { padding: 15px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: flex-start; }
    .menu-info { padding-right: 15px; flex: 1; }
    .menu-info h4 { margin: 0 0 5px; font-size: 0.95rem; color: var(--dark); }
    .menu-info p { margin: 0; font-size: 0.8rem; color: #888; line-height: 1.4; }
    
    .menu-note-badge {
      display: inline-block; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
      margin-top: 5px; font-weight: 600;
    }
    .note-warn { background: #ffebee; color: #c0392b; border: 1px solid #ffcdd2; }
    .note-info { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }

    /* BOTTOM BAR */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: white; padding: 15px 20px;
      padding-bottom: calc(15px + env(safe-area-inset-bottom));
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
      display: flex; justify-content: space-between; align-items: center;
      z-index: 900; border-top-left-radius: 20px; border-top-right-radius: 20px;
    }
    .btn-action {
      background: var(--primary); color: white; border: none;
      padding: 14px 25px; border-radius: 50px; font-weight: 600;
      box-shadow: 0 5px 15px rgba(42, 157, 143, 0.4); cursor: pointer;
      display: flex; align-items: center; gap: 10px; font-size: 1rem;
    }
    .btn-back {
      background: #f5f5f5; color: #555; border: none;
      width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;
      display: flex; justify-content: center; align-items: center;
    }

    /* MODAL */
    .image-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); justify-content: center; align-items: center; flex-direction: column; }
    .modal-content { max-width: 90%; max-height: 70vh; border-radius: 10px; }
    .close-modal { position: absolute; top: 30px; right: 30px; color: white; font-size: 2.5rem; cursor: pointer; background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .step-section { display: none; }
    .step-section.active { display: block; }

    /* ========================================= */
    /* ADMIN PANEL STYLES (NEW) */
    /* ========================================= */
    .admin-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f0f2f5; z-index: 5000; overflow-y: auto;
    }
    .admin-header {
      background: var(--dark); color: white; padding: 20px;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 100;
    }
    .admin-container { max-width: 800px; margin: 20px auto; padding: 0 15px; padding-bottom: 50px; }
    
    /* Login Form */
    .login-box {
      max-width: 400px; margin: 100px auto; background: white; padding: 30px;
      border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center;
    }
    .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }

    /* Admin List */
    .admin-card {
      background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 10px;
    }
    .admin-card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .admin-card h4 { margin: 0; color: var(--dark); font-size: 1rem; }
    
    .upload-area {
      display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap;
    }
    .img-preview-box {
      width: 100px; height: 100px; background: #eee; border-radius: 8px; overflow: hidden; flex-shrink: 0; position: relative;
    }
    .img-preview-box img { width: 100%; height: 100%; object-fit: cover; }
    .upload-controls { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 200px; }
    
    .file-input { font-size: 0.9rem; }
    .btn-upload-save {
      background: var(--secondary); color: var(--dark); border: none; padding: 8px 15px;
      border-radius: 6px; font-weight: 600; cursor: pointer; align-self: flex-start;
      display: flex; align-items: center; gap: 5px; font-size: 0.9rem;
    }
    .progress-bar { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; display: none; margin-top: 5px; }
    .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }

  </style>
</head>
<body>

  <header id="mainHeader">
    <h1><i class="fas fa-leaf"></i> Dolan Sawah</h1>
    <div class="dynamic-title" id="headerTitle">Halo, Silahkan pilih waktu reservasi Anda</div>
    
    <div class="step-indicator">
      <div class="step-wrapper active" id="dot1"><div class="step-dot"></div><span class="step-label">Waktu</span></div>
      <div class="step-wrapper" id="dot2"><div class="step-dot"></div><span class="step-label">Tempat</span></div>
      <div class="step-wrapper" id="dot3"><div class="step-dot"></div><span class="step-label">Menu</span></div>
      <div class="step-wrapper" id="dot4"><div class="step-dot"></div><span class="step-label">Data</span></div>
    </div>
  </header>

  <div class="loader-overlay" id="loader">
    <div class="spinner"></div><p style="color:#666; font-size:0.9rem;">Menyiapkan Data...</p>
  </div>

  <div id="imgModal" class="image-modal" onclick="closeImage()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg">
    <p style="color:white; margin-top:15px; font-weight:600;" id="modalCaption"></p>
  </div>

  <div class="container">
    
    <div id="step1" class="step-section active">
      <div class="card">
        <div class="input-group-custom" id="groupDate">
          <div class="input-visual">
            <i class="far fa-calendar-alt"></i>
            <div class="label-text"><span>Tanggal Kunjungan</span><strong id="displayDate">Pilih Tanggal</strong></div>
          </div>
          <input type="date" id="inputDate" class="hidden-input" onchange="updateDateUI()">
          <div class="error-msg">Mohon pilih tanggal.</div>
        </div>

        <div class="input-group-custom" id="groupTime">
          <div class="input-visual">
            <i class="far fa-clock"></i>
            <div class="label-text"><span>Jam Kedatangan</span><strong id="displayTime">--:--</strong></div>
          </div>
          <input type="time" id="inputTime" class="hidden-input" onchange="updateTimeUI()">
          <div class="error-msg">Mohon tentukan jam.</div>
        </div>

        <div class="input-group-custom">
            <label style="font-size:0.85rem; color:#666; margin-bottom:8px; display:block;">Jumlah Orang</label>
            <div class="stepper-control">
                <button class="stepper-btn" onclick="updatePaxStep(-1)">-</button>
                <input type="number" id="inputPax" class="stepper-input" value="2" min="1" onchange="validatePax()">
                <button class="stepper-btn" onclick="updatePaxStep(1)">+</button>
            </div>
        </div>
      </div>
    </div>

    <div id="step2" class="step-section">
      <div class="card" style="background:#e3f2fd; border-left:4px solid #2196f3; padding:15px;">
        <p style="font-size:0.85rem; color:#0d47a1; margin:0;"><i class="fas fa-info-circle"></i> Klik kartu untuk memilih tempat.</p>
      </div>
      <div class="location-grid" id="locationList"></div>
    </div>

    <div id="step3" class="step-section">
      <div class="card" style="padding:15px;">
        <p style="font-size:0.85rem; color:#666; margin-bottom:15px; text-align:center;">Pilih kategori menu di bawah ini</p>
        <div id="menuContainer"></div>
      </div>
    </div>

    <div id="step4" class="step-section">
      <div class="card">
        <div class="input-group-custom" id="groupName">
            <label style="font-size:0.85rem; color:#666; margin-bottom:5px; display:block;">Nama Lengkap</label>
            <input type="text" id="inputName" placeholder="Contoh: Budi Santoso" style="width:100%; padding:12px; border:2px solid #eee; border-radius:10px; font-size:1rem;">
            <div class="error-msg">Nama wajib diisi.</div>
        </div>
        <div class="input-group-custom" id="groupPhone">
            <label style="font-size:0.85rem; color:#666; margin-bottom:5px; display:block;">WhatsApp (Aktif)</label>
            <input type="tel" id="inputPhone" placeholder="Contoh: 081234..." style="width:100%; padding:12px; border:2px solid #eee; border-radius:10px; font-size:1rem;">
            <div class="error-msg">Nomor wajib diisi.</div>
        </div>
        <div style="margin-bottom:15px;">
            <label style="font-size:0.85rem; color:#666; margin-bottom:5px; display:block;">Catatan (Opsional)</label>
            <textarea id="inputNote" rows="2" placeholder="Contoh: Kursi bayi, dll..." style="width:100%; padding:12px; border:2px solid #eee; border-radius:10px; font-family:inherit;"></textarea>
        </div>
        <div style="background:#f1f8e9; padding:15px; border-radius:12px; border:1px solid #c5e1a5;">
            <h5 style="margin:0 0 10px; color:#33691e;"><i class="fas fa-check-circle"></i> Ringkasan</h5>
            <div style="font-size:0.85rem; color:#558b2f; line-height:1.6;">
                <div style="display:flex; justify-content:space-between;"><span>Waktu:</span> <strong id="summaryDate"></strong></div>
                <div style="display:flex; justify-content:space-between;"><span>Jam:</span> <strong id="summaryTime"></strong></div>
                <div style="display:flex; justify-content:space-between;"><span>Orang:</span> <strong id="summaryPax"></strong></div>
                <div style="display:flex; justify-content:space-between;"><span>Tempat:</span> <strong id="summaryLoc"></strong></div>
                <div style="display:flex; justify-content:space-between; margin-top:5px; border-top:1px dashed #c5e1a5; padding-top:5px;"><span>Total Menu:</span> <strong id="summaryMenu">0 Item</strong></div>
            </div>
        </div>
      </div>
    </div>

  </div>

  <div class="bottom-bar">
    <button class="btn-back" id="btnBack" onclick="prevStep()" style="display:none;"><i class="fas fa-arrow-left"></i></button>
    <div id="priceInfo" style="display:none; flex-grow:1; margin-left:15px;">
        <span style="display:block; font-size:0.7rem; color:#888; text-transform:uppercase;">Keranjang</span>
        <strong style="color:var(--primary); font-size:1.1rem;" id="totalItemText">0 Menu</strong>
    </div>
    <button class="btn-action" id="btnNext" onclick="nextStep()">Cari Tempat <i class="fas fa-search"></i></button>
  </div>

  <div id="adminPanel" class="admin-overlay">
    
    <div class="admin-header">
      <div style="font-weight:700;"><i class="fas fa-user-cog"></i> Admin Panel</div>
      <button onclick="closeAdmin()" style="background:transparent; border:1px solid rgba(255,255,255,0.3); color:white; padding:5px 12px; border-radius:6px; cursor:pointer;">
        Close <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="adminLoginView" class="login-box" style="display:none;">
      <h3 style="color:var(--primary-dark); margin-bottom:20px;">Login Admin</h3>
      <input type="email" id="adminEmail" class="login-input" placeholder="Email Admin">
      <input type="password" id="adminPass" class="login-input" placeholder="Password">
      <button class="btn-login" onclick="adminLogin()">Masuk</button>
      <p id="loginError" style="color:red; font-size:0.8rem; display:none; margin-top:10px;"></p>
    </div>

    <div id="adminDashboardView" class="admin-container" style="display:none;">
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; color:var(--dark);">Kelola Foto Tempat</h3>
        <button onclick="adminLogout()" style="background:#e74c3c; color:white; border:none; padding:8px 15px; border-radius:6px; font-size:0.8rem; cursor:pointer;">Logout</button>
      </div>
      
      <div class="card" style="background:#fff3cd; color:#856404; font-size:0.85rem; margin-bottom:20px;">
        <i class="fas fa-info-circle"></i> <b>Panduan:</b> Pilih file gambar baru, lalu klik tombol "Upload & Simpan". Gambar di website akan langsung berubah.
      </div>

      <div id="adminLocationList">
        <div style="text-align:center; padding:20px;"><div class="spinner"></div></div>
      </div>

    </div>
  </div>

  <script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    const defaultImage = "https://via.placeholder.com/300x200?text=Dolan+Sawah";

    let currentStep = 1;
    let locationsData = [];
    let menusData = {};
    let selectedMenus = {}; 
    let selectedLocationName = "";
    
    // Admin Variables
    let clickCount = 0;
    let clickTimer = null;

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('inputDate').setAttribute('min', new Date().toISOString().split('T')[0]);
      await loadData();
      document.getElementById('loader').style.display = 'none';
      updateUIState();
      
      // Setup Secret Trigger for Admin
      const headerTitle = document.querySelector('#mainHeader h1');
      headerTitle.addEventListener('click', () => {
        clickCount++;
        if(clickTimer) clearTimeout(clickTimer);
        clickTimer = setTimeout(() => { clickCount = 0; }, 2000); // Reset kalau lebih dari 2 detik

        if(clickCount === 5) {
            clickCount = 0;
            openAdmin();
        }
      });
    });

    // --- PAX INPUT LOGIC ---
    function updatePaxStep(amount) {
        const input = document.getElementById('inputPax');
        let val = parseInt(input.value) || 0;
        val += amount;
        if(val < 1) val = 1;
        input.value = val;
    }
    function validatePax() {
        const input = document.getElementById('inputPax');
        if(parseInt(input.value) < 1) input.value = 1;
    }

    // --- DATE/TIME UI ---
    function updateDateUI() {
        const val = document.getElementById('inputDate').value;
        const display = document.getElementById('displayDate');
        if(val) {
            display.textContent = new Date(val).toLocaleDateString('id-ID', { weekday:'short', day:'numeric', month:'short', year:'numeric' });
            display.style.color = 'var(--primary-dark)';
            document.getElementById('groupDate').classList.remove('error');
        } else display.textContent = "Pilih Tanggal";
    }
    function updateTimeUI() {
        const val = document.getElementById('inputTime').value;
        const display = document.getElementById('displayTime');
        if(val) {
            display.textContent = val;
            display.style.color = 'var(--primary-dark)';
            document.getElementById('groupTime').classList.remove('error');
        } else display.textContent = "--:--";
    }

    // --- DATA LOADING ---
    async function loadData() {
      try {
        // Load Locations
        try {
            let snap = await db.collection('locations').get();
            if(snap.empty) snap = await db.collection('Locations').get(); // Fallback case sensitivity
            locationsData = [];
            snap.forEach(doc => locationsData.push({ id: doc.id, ...doc.data() }));
        } catch(e) { console.error("Error loading locations:", e); }

        // Load Menus
        try {
            let snap = await db.collection('menus').get();
            menusData = {};
            snap.forEach(doc => {
               let d = doc.data();
               let desc = Array.isArray(d.details) ? d.details.join(", ") : (d.deskripsi || "");
               menusData[doc.id] = { name: doc.id, desc: desc, category: categorizeMenu(doc.id) };
            });
        } catch(e) { console.error("Error loading menus:", e); }
        
        renderMenuAccordions();
      } catch (err) { console.error(err); }
    }

    // --- MENU LOGIC ---
    function categorizeMenu(name) {
        const n = name.toLowerCase();
        if(n.includes("jeep") || n.includes("jip")) return "Wisata Jeep";
        if(n.includes("prasmanan") || n.includes("buffet") || n.match(/paket [a-j](?!\w)/)) return "Prasmanan";
        if(n.includes("tumpeng") || n.includes("kembulan") || n.includes("bancakan")) return "Kembulan";
        if(n.includes("rantang") || n.includes("besek") || n.includes("box")) return "Paket Rantang";
        if(n.includes("grill") || n.includes("bbq")) return "Grill & BBQ";
        if(n.includes("minum") || n.includes("wedang") || n.includes("jus")) return "Minuman";
        return "Menu Lainnya";
    }

    function getMenuNote(name, category) {
        const n = name.toLowerCase();
        if(category === "Prasmanan") return `<span class="menu-note-badge note-warn">Min. order 20 porsi</span>`;
        if(n.includes("kembulan 1") || n.includes("kembulan 2")) return `<span class="menu-note-badge note-info">Porsi untuk 5 Orang</span>`;
        if(n.includes("kembulan 3") || n.includes("kembulan 4") || n.includes("kembulan 5") || n.includes("kembulan 6")) return `<span class="menu-note-badge note-info">Porsi untuk 10 Orang</span>`;
        if(n.includes("tumpeng")) return `<span class="menu-note-badge note-info">Porsi untuk 5 Orang</span>`;
        return "";
    }

    function renderMenuAccordions() {
        const container = document.getElementById('menuContainer');
        container.innerHTML = "";
        const groups = {};
        Object.values(menusData).forEach(item => {
            if(!groups[item.category]) groups[item.category] = [];
            groups[item.category].push(item);
        });

        const order = ["Wisata Jeep", "Prasmanan", "Kembulan", "Paket Rantang", "Grill & BBQ", "Minuman", "Menu Lainnya"];
        
        order.forEach(cat => {
            if(groups[cat]) {
                const safeCat = cat.replace(/\s+/g, '-');
                const section = document.createElement('div');
                section.className = 'menu-category';
                let htmlItems = "";
                
                groups[cat].sort((a,b)=>a.name.localeCompare(b.name)).forEach(menu => {
                    const note = getMenuNote(menu.name, cat);
                    htmlItems += `
                        <div class="menu-item">
                            <div class="menu-info">
                                <h4>${menu.name}</h4>
                                <p>${menu.desc}</p>
                                ${note}
                            </div>
                            <div class="stepper-control" style="width:110px;">
                                <button class="stepper-btn" onclick="updateMenuQty('${menu.name}', -1, '${safeCat}')">-</button>
                                <input type="number" id="qty-${cleanId(menu.name)}" class="stepper-input" value="0" min="0" onchange="manualMenuQty('${menu.name}', '${safeCat}')">
                                <button class="stepper-btn" onclick="updateMenuQty('${menu.name}', 1, '${safeCat}')">+</button>
                            </div>
                        </div>
                    `;
                });
                
                section.innerHTML = `
                    <div class="cat-header" onclick="toggleAccordion(this)">
                        <div style="display:flex; align-items:center;">
                            <span>${cat}</span> <span class="cat-badge" id="badge-${safeCat}">0</span>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="cat-content">${htmlItems}</div>
                `;
                container.appendChild(section);
            }
        });
    }

    function toggleAccordion(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('i');
        document.querySelectorAll('.cat-content').forEach(el => { if(el !== content) el.classList.remove('show'); });
        content.classList.toggle('show');
        icon.className = content.classList.contains('show') ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    }

    // --- MENU QTY LOGIC ---
    function updateMenuQty(name, change, safeCat) {
        const id = cleanId(name);
        const input = document.getElementById(`qty-${id}`);
        let val = parseInt(input.value) || 0;
        val += change;
        if(val < 0) val = 0;
        input.value = val;
        syncMenuData(name, val, safeCat);
    }
    function manualMenuQty(name, safeCat) {
        const id = cleanId(name);
        const input = document.getElementById(`qty-${id}`);
        let val = parseInt(input.value) || 0;
        if(val < 0) val = 0;
        input.value = val;
        syncMenuData(name, val, safeCat);
    }
    function syncMenuData(name, val, safeCat) {
        if(val === 0) delete selectedMenus[name];
        else selectedMenus[name] = val;

        const total = Object.values(selectedMenus).reduce((a,b)=>a+b,0);
        document.getElementById('totalItemText').textContent = `${total} Menu`;
        
        let catCount = 0;
        for(let key in selectedMenus) {
             let c = categorizeMenu(key).replace(/\s+/g, '-');
             if(c === safeCat) catCount += selectedMenus[key];
        }
        const badge = document.getElementById(`badge-${safeCat}`);
        if(badge) { badge.textContent = catCount; badge.style.display = catCount > 0 ? 'inline-block' : 'none'; }
    }
    function cleanId(str) { return str.replace(/[^a-zA-Z0-9]/g, '-'); }

    // --- NAVIGATION ---
    async function nextStep() {
        if(currentStep === 1) {
            const date = document.getElementById('inputDate').value;
            const time = document.getElementById('inputTime').value;
            let isValid = true;
            if(!date) { document.getElementById('groupDate').classList.add('error'); isValid = false; }
            if(!time) { document.getElementById('groupTime').classList.add('error'); isValid = false; }
            if(!isValid) return;
            await checkAvailability();
            currentStep = 2;
        } 
        else if(currentStep === 2) {
            if(!selectedLocationName) return Swal.fire('Belum Ada Tempat', 'Pilih tempat dulu.', 'warning');
            currentStep = 3;
        }
        else if(currentStep === 3) {
            if(Object.keys(selectedMenus).length === 0) return Swal.fire('Menu Kosong', 'Pilih minimal 1 menu.', 'warning');
            document.getElementById('summaryDate').textContent = document.getElementById('displayDate').textContent;
            document.getElementById('summaryTime').textContent = document.getElementById('inputTime').value;
            document.getElementById('summaryPax').textContent = document.getElementById('inputPax').value + " Orang";
            document.getElementById('summaryLoc').textContent = selectedLocationName;
            document.getElementById('summaryMenu').textContent = Object.values(selectedMenus).reduce((a,b)=>a+b,0) + " Item";
            currentStep = 4;
        }
        else if(currentStep === 4) {
            const name = document.getElementById('inputName').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            if(!name) return document.getElementById('groupName').classList.add('error');
            if(!phone) return document.getElementById('groupPhone').classList.add('error');
            submitReservation();
            return;
        }
        updateUIState();
        window.scrollTo(0,0);
    }
    
    function prevStep() { if(currentStep > 1) currentStep--; updateUIState(); }

    function updateUIState() {
        document.querySelectorAll('.step-section').forEach((el, idx) => el.classList.toggle('active', (idx + 1) === currentStep));
        document.querySelectorAll('.step-wrapper').forEach((el, idx) => {
            el.classList.toggle('active', (idx + 1) === currentStep);
            el.classList.toggle('completed', (idx + 1) < currentStep);
        });
        document.getElementById('headerTitle').textContent = ["Halo, Silahkan pilih waktu reservasi Anda", "Pilih Tempat Duduk", "Pilih Menu Favorit", "Isi Data Diri"][currentStep-1];
        
        const btnNext = document.getElementById('btnNext');
        const btnBack = document.getElementById('btnBack');
        const priceInfo = document.getElementById('priceInfo');
        
        if(currentStep === 1) { btnBack.style.display = 'none'; btnNext.innerHTML = 'Cari Tempat <i class="fas fa-search"></i>'; priceInfo.style.display = 'none'; }
        else if(currentStep === 2) { btnBack.style.display = 'flex'; btnNext.innerHTML = 'Lanjut Menu <i class="fas fa-arrow-right"></i>'; priceInfo.style.display = 'none'; }
        else if(currentStep === 3) { btnBack.style.display = 'flex'; btnNext.innerHTML = 'Lanjut Data <i class="fas fa-arrow-right"></i>'; priceInfo.style.display = 'flex'; }
        else if(currentStep === 4) { btnBack.style.display = 'flex'; btnNext.innerHTML = 'Kirim Reservasi <i class="fas fa-paper-plane"></i>'; priceInfo.style.display = 'none'; }
    }

    // --- CHECK AVAILABILITY LOGIC (UPDATED WITH FIREBASE IMAGES) ---
    async function checkAvailability() {
        const dateVal = document.getElementById('inputDate').value;
        const paxVal = parseInt(document.getElementById('inputPax').value) || 1;
        const container = document.getElementById('locationList');
        container.innerHTML = '<div class="spinner" style="margin:20px auto;"></div>';

        try {
            const snapshot = await db.collection('reservations').where('date', '==', dateVal).get();
            const usageMap = {};
            let isLantai1FullBooked = false;

            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.tempat) {
                    usageMap[d.tempat] = (usageMap[d.tempat] || 0) + (parseInt(d.jumlah) || 0);
                    if (d.tempat.toLowerCase().includes("lantai 1 full blok")) {
                        isLantai1FullBooked = true;
                    }
                }
            });

            container.innerHTML = '';
            locationsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(loc => {
                const locNameLower = loc.name.toLowerCase();
                const used = usageMap[loc.name] || 0;
                let capacity = loc.capacity;
                let remaining = capacity - used;
                let isFull = remaining < paxVal;
                let customError = "";

                // Logic Override Full Blok
                if (isLantai1FullBooked) {
                    if (locNameLower.includes("lantai 1 depan") || 
                        locNameLower.includes("lantai 1 tengah") || 
                        locNameLower.includes("lantai 1 belakang")) {
                        isFull = true;
                        remaining = 0; 
                    }
                }
                
                if(locNameLower.includes("full blok") && paxVal < 200) { 
                    isFull = true; 
                    customError = "Min. 200 Orang"; 
                }
                
                let capClass = "cap-safe";
                if(remaining <= 0) capClass = "cap-full";
                
                // --- UPDATE: AMBIL GAMBAR DARI DB ---
                const imageUrl = loc.imageUrl || defaultImage;
                // -------------------------------------

                const div = document.createElement('div');
                div.className = `location-option ${isFull ? 'disabled' : ''}`;
                if(selectedLocationName === loc.name && !isFull) div.classList.add('selected');
                
                div.innerHTML = `
                    <div class="loc-thumb-wrapper">
                        <img src="${imageUrl}" class="loc-thumb-img" loading="lazy">
                        ${customError ? `<span style="position:absolute; bottom:0; width:100%; background:rgba(231,76,60,0.9); color:white; font-size:0.7rem; text-align:center;">${customError}</span>` : ''}
                    </div>
                    <div class="loc-content">
                        <span class="loc-name">${loc.name}</span>
                        <span class="cap-badge ${capClass}">${remaining<=0?'PENUH':`Sisa ${remaining}`}</span>
                        <button class="btn-loc-view" onclick="openImage('${imageUrl}', '${loc.name}')">
                            <i class="fas fa-images"></i> Lihat Foto
                        </button>
                    </div>
                    <div style="position:absolute; top:0; left:0; width:100%; height:100%; cursor:pointer;" onclick="selectLocation('${loc.name}', this)"></div>
                `;
                container.appendChild(div);
            });
        } catch(e) {
            console.error(e);
            container.innerHTML = '<p style="text-align:center; color:red;">Gagal memuat data.</p>';
        }
    }

    function selectLocation(name, el) {
        selectedLocationName = name;
        document.querySelectorAll('.location-option').forEach(e => e.classList.remove('selected'));
        el.closest('.location-option').classList.add('selected');
    }

    async function submitReservation() {
        Swal.showLoading();
        try {
            await db.collection('reservation_requests').add({
                date: document.getElementById('inputDate').value,
                jam: document.getElementById('inputTime').value,
                jumlah: parseInt(document.getElementById('inputPax').value),
                tempat: selectedLocationName,
                nama: document.getElementById('inputName').value,
                nomorHp: document.getElementById('inputPhone').value.replace(/[^0-9]/g,'').replace(/^0/,'62'),
                tambahan: document.getElementById('inputNote').value,
                menus: Object.entries(selectedMenus).map(([k,v]) => ({name:k, quantity:v})),
                status: 'pending',
                via: 'Web App V8',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            Swal.fire({ icon: 'success', title: 'Terkirim!', text: 'Admin akan menghubungi WhatsApp Anda.', confirmButtonColor: 'var(--primary)' }).then(() => window.location.reload());
        } catch(e) { Swal.fire('Error', 'Gagal koneksi.', 'error'); }
    }

    function openImage(url, caption) { 
        event.stopPropagation(); 
        document.getElementById('imgModal').style.display = 'flex'; 
        document.getElementById('modalImg').src = url; 
        document.getElementById('modalCaption').textContent = caption; 
    }
    function closeImage() { document.getElementById('imgModal').style.display = 'none'; }

    // ===============================================
    // ADMIN FUNCTIONS
    // ===============================================

    function openAdmin() {
      document.getElementById('adminPanel').style.display = 'block';
      
      // Cek status login
      auth.onAuthStateChanged(user => {
        if(user) {
          showAdminDashboard();
        } else {
          showAdminLogin();
        }
      });
    }

    function closeAdmin() {
      document.getElementById('adminPanel').style.display = 'none';
    }

    function showAdminLogin() {
      document.getElementById('adminLoginView').style.display = 'block';
      document.getElementById('adminDashboardView').style.display = 'none';
    }

    function showAdminDashboard() {
      document.getElementById('adminLoginView').style.display = 'none';
      document.getElementById('adminDashboardView').style.display = 'block';
      renderAdminLocations();
    }

    function adminLogin() {
      const email = document.getElementById('adminEmail').value;
      const pass = document.getElementById('adminPass').value;
      const errEl = document.getElementById('loginError');

      if(!email || !pass) { errEl.textContent = "Isi email dan password."; errEl.style.display = 'block'; return; }

      auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
          errEl.style.display = 'none';
          showAdminDashboard();
        })
        .catch(error => {
          errEl.textContent = "Login gagal: " + error.message;
          errEl.style.display = 'block';
        });
    }

    function adminLogout() {
      auth.signOut().then(() => {
        showAdminLogin();
      });
    }

    async function renderAdminLocations() {
      const container = document.getElementById('adminLocationList');
      container.innerHTML = '<div class="spinner"></div>';
      
      // Reload data to be sure
      await loadData();
      
      container.innerHTML = '';
      locationsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(loc => {
        const currentImg = loc.imageUrl || defaultImage;
        
        const card = document.createElement('div');
        card.className = 'admin-card';
        card.innerHTML = `
          <div class="admin-card-header">
             <h4>${loc.name}</h4>
             <small style="color:#888;">Kapasitas: ${loc.capacity}</small>
          </div>
          <div class="upload-area">
             <div class="img-preview-box">
                <img src="${currentImg}" id="preview-${loc.id}">
             </div>
             <div class="upload-controls">
                <input type="file" id="file-${loc.id}" accept="image/*" class="file-input">
                <button class="btn-upload-save" onclick="handleFileUpload('${loc.id}')">
                   <i class="fas fa-cloud-upload-alt"></i> Upload & Simpan
                </button>
                <div class="progress-bar" id="prog-bar-${loc.id}">
                   <div class="progress-fill" id="prog-fill-${loc.id}"></div>
                </div>
             </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function handleFileUpload(locId) {
  const fileInput = document.getElementById(`file-${locId}`);
  const file = fileInput.files[0];

  if (!file) {
    Swal.fire('Peringatan', 'Pilih foto dulu!', 'warning');
    return;
  }

  const progBar = document.getElementById(`prog-bar-${locId}`);
  const progFill = document.getElementById(`prog-fill-${locId}`);
  progBar.style.display = 'block';
  progFill.style.width = '0%';

  const ext = file.name.split('.').pop();
  const filePath = `location_images/${locId}_${Date.now()}.${ext}`;

  const storageRef = firebase.storage().ref(filePath);
  const metadata = {
    contentType: file.type
  };

  const uploadTask = storageRef.put(file, metadata);

  uploadTask.on(
    'state_changed',
    snapshot => {
      const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      progFill.style.width = progress + '%';
    },
    error => {
      console.error(error);
      Swal.fire('Error', error.message, 'error');
      progBar.style.display = 'none';
    },
    async () => {
      const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
      await db.collection('locations').doc(locId).update({
        imageUrl: downloadURL
      });

      document.getElementById(`preview-${locId}`).src = downloadURL;
      progBar.style.display = 'none';
      Swal.fire('Berhasil!', 'Foto lokasi berhasil diperbarui.', 'success');
    }
  );
}

  </script>
</body>
</html>

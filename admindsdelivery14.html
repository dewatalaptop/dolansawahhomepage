<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dolan Sawah</title>
    
    <style>
        /* Reset & Font Dasar */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f9f9f9; color: #333; line-height: 1.6; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 1rem; }

        /* --- Header --- */
        header { background-color: #2c5e2e; color: white; padding: 1rem; text-align: center; border-radius: 8px; margin-bottom: 1.5rem; }
        header h1 { font-size: 1.75rem; }
        
        /* --- Navigasi Tab --- */
        nav { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #ddd; }
        .nav-tab { padding: 0.8rem 1.5rem; cursor: pointer; font-size: 1.1rem; font-weight: 600; border: none; background: none; color: #777; border-bottom: 3px solid transparent; }
        .nav-tab.active { color: #2c5e2e; border-bottom-color: #2c5e2e; }
        
        /* --- Konten Section --- */
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        /* --- Styling Form --- */
        .form-card { background-color: #ffffff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); margin-bottom: 1.5rem; }
        .form-card h2 { font-size: 1.4rem; color: #2c5e2e; margin-bottom: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        .submit-btn { background-color: #2c5e2e; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        .submit-btn:hover { background-color: #1e421e; }
        .submit-btn.edit-mode { background-color: #d39e00; }
        .submit-btn.edit-mode:hover { background-color: #a67c00; }

        .cancel-edit-btn { background-color: #6c757d; margin-top: 10px; display: none; }
        
        /* --- Daftar Item & Pencarian --- */
        .list-container { background-color: #ffffff; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px; }
        .list-header h2 { margin: 0; font-size: 1.4rem; }
        
        /* Style Input Pencarian */
        .search-box { width: 100%; max-width: 300px; }
        .search-box input { width: 100%; padding: 0.5rem 1rem; border: 1px solid #ccc; border-radius: 20px; font-size: 0.95rem; background-color: #f8f8f8; }
        .search-box input:focus { border-color: #2c5e2e; background-color: #fff; outline: none; }

        /* Style Item Kompak */
        .list-item { 
            display: flex; 
            align-items: center; 
            padding: 0.75rem; 
            border: 1px solid #eee; 
            border-radius: 6px;
            margin-bottom: 8px;
            background: #fff;
            transition: box-shadow 0.2s;
        }
        .list-item:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .list-item img { 
            width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 1rem; flex-shrink: 0;
        }
        
        .item-info { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;}
        .item-name-group { display: flex; flex-direction: column; }
        .item-info h3 { font-size: 1rem; font-weight: 600; margin: 0; }
        .item-category { font-size: 0.8rem; color: #888; }
        
        .status-badge { font-size: 0.7rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; margin-left: 5px; display: inline-block; vertical-align: middle; }
        .status-badge.available { background: #d4edda; color: #155724; }
        .status-badge.unavailable { background: #f8d7da; color: #721c24; }

        .item-actions { display: flex; gap: 5px; margin-left: auto; }
        
        .action-btn { border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: 500; color: white; transition: opacity 0.2s;}
        .action-btn:hover { opacity: 0.9; }
        
        .btn-toggle { background: #17a2b8; min-width: 60px; }
        .btn-toggle.is-off { background: #6c757d; }
        .btn-edit { background: #ffc107; color: #212529; }
        .btn-delete { background: #dc3545; }

        /* --- Notifikasi --- */
        #admin-status { text-align: center; padding: 10px; margin-bottom: 10px; border-radius: 6px; font-weight: 600; display: none; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }

    </style>
</head>
<body>

    <header>
        <h1>Admin - Dolan Sawah Delivery</h1>
    </header>

    <main class="container">
        
        <nav>
            <button class="nav-tab active" data-tab="menu">Kelola Menu</button>
            <button class="nav-tab" data-tab="voucher">Kelola Voucher</button>
        </nav>
        
        <div id="admin-status" class="status-success">Pesan sistem</div>

        <section id="content-menu" class="content-section active">
            
            <div class="form-card">
                <h2 id="form-title">Tambah Menu Baru</h2>
                <form id="form-menu">
                    <input type="hidden" id="menu-id">
                    <div class="form-group">
                        <label for="menu-name">Nama Menu</label>
                        <input type="text" id="menu-name" placeholder="Contoh: Nasi Pecel Komplit" required>
                    </div>
                    <div class="form-group">
                        <label for="menu-category">Kategori</label>
                        <input type="text" id="menu-category" placeholder="Contoh: Makanan / Minuman" required>
                    </div>
                    <div class="form-group">
                        <label for="menu-description">Deskripsi</label>
                        <textarea id="menu-description" placeholder="Contoh: Nasi pecel, tempe, tahu..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="menu-price">Harga (Rp)</label>
                        <input type="number" id="menu-price" placeholder="Contoh: 20000" required>
                    </div>
                    <div class="form-group">
                        <label for="menu-img">Link Foto Menu</label>
                        <input type="url" id="menu-img" placeholder="https://..." required>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="btn-save-menu">Simpan Menu</button>
                    <button type="button" class="submit-btn cancel-edit-btn" id="btn-cancel-edit">Batal Edit</button>
                </form>
            </div>
            
            <div class="list-container">
                <div class="list-header">
                    <h2>Daftar Menu</h2>
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="ðŸ” Cari menu...">
                    </div>
                </div>
                
                <div id="menu-list">
                    <p style="text-align:center;">Memuat menu...</p>
                </div>
            </div>
        </section>

        <section id="content-voucher" class="content-section">
            <div class="form-card">
                <h2>Tambah Voucher Baru</h2>
                <form id="form-add-voucher">
                    <div class="form-group">
                        <label for="voucher-code">Kode Voucher</label>
                        <input type="text" id="voucher-code-input" placeholder="Contoh: HEMAT10K" required>
                    </div>
                    <div class="form-group">
                        <label for="voucher-min">Minimal Transaksi (Rp)</label>
                        <input type="number" id="voucher-min" placeholder="Contoh: 75000" required>
                    </div>
                    <div class="form-group">
                        <label for="voucher-discount">Nilai Diskon (Rp)</label>
                        <input type="number" id="voucher-discount" placeholder="Contoh: 10000" required>
                    </div>
                    <button type="submit" class="submit-btn" id="btn-add-voucher">Simpan Voucher</button>
                </form>
            </div>
            <div class="list-container">
                <h2>Daftar Voucher</h2>
                <div id="voucher-list">
                    <p style="text-align:center;">Memuat voucher...</p>
                </div>
            </div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCNqxbEgn6cU6YbZ9J4YveO25OZsoAXhxQ",
            authDomain: "ds-delivery-7ddeb.firebaseapp.com",
            projectId: "ds-delivery-7ddeb",
            storageBucket: "ds-delivery-7ddeb.firebasestorage.app",
            messagingSenderId: "887090941316",
            appId: "1:887090941316:web:be3a8c83a59dcdb2e261d1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- STATE ---
        let products = [];
        let vouchers = [];

        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID').format(number);
        }
        
        function showStatus(message, isSuccess = true) {
            const statusDiv = document.getElementById('admin-status');
            statusDiv.innerText = message;
            statusDiv.className = isSuccess ? 'status-success' : 'status-error';
            statusDiv.style.display = 'block';
            setTimeout(() => statusDiv.style.display = 'none', 3000);
        }
        
        // --- FETCH DATA ---
        async function fetchData() {
            await fetchProducts();
            await fetchVouchers();
        }

        async function fetchProducts() {
             try {
                const prodSnapshot = await getDocs(collection(db, "products"));
                products = prodSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort A-Z Default
                products.sort((a, b) => a.name.localeCompare(b.name));
                renderMenuList();
            } catch (error) {
                console.error("Error fetching products:", error);
                document.getElementById('menu-list').innerHTML = '<p style="color:red;">Gagal memuat menu.</p>';
            }
        }
        
        async function fetchVouchers() {
             try {
                const voucherSnapshot = await getDocs(collection(db, "vouchers"));
                vouchers = voucherSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderVoucherList();
            } catch (error) {
                console.error("Error fetching vouchers:", error);
            }
        }

        // --- RENDER UI ---
        
        // Fungsi Render Menu dengan dukungan Search Filter
        function renderMenuList() {
            const listContainer = document.getElementById('menu-list');
            const searchText = document.getElementById('search-input').value.toLowerCase();
            
            listContainer.innerHTML = ''; 
            
            // Filter berdasarkan pencarian
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchText)
            );
            
            if (filteredProducts.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; padding: 20px; color:#888;">Menu tidak ditemukan.</p>';
                return;
            }
            
            filteredProducts.forEach(product => {
                const isAvailable = product.isAvailable !== false;
                const item = document.createElement('div');
                item.className = 'list-item';
                
                item.innerHTML = `
                    <img src="${product.img}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="item-info">
                        <div class="item-name-group">
                            <h3>${product.name} 
                                <span class="status-badge ${isAvailable ? 'available' : 'unavailable'}">
                                    ${isAvailable ? 'Ada' : 'Habis'}
                                </span>
                            </h3>
                            <span class="item-category">Rp ${formatRupiah(product.price)} â€¢ ${product.category}</span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn btn-toggle ${!isAvailable ? 'is-off' : ''}" data-id="${product.id}" data-status="${isAvailable}" title="Ubah Status">
                            ${isAvailable ? 'Set Habis' : 'Set Ada'}
                        </button>
                        <button class="action-btn btn-edit" data-id="${product.id}" title="Edit Menu">Edit</button>
                        <button class="action-btn btn-delete" data-id="${product.id}" data-collection="products" title="Hapus Menu">Hapus</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            
            // Setup listener tombol
            setupItemListeners(listContainer);
        }

        function setupItemListeners(container) {
            container.querySelectorAll('.btn-delete').forEach(btn => btn.onclick = handleDelete);
            container.querySelectorAll('.btn-toggle').forEach(btn => btn.onclick = handleToggleAvailability);
            container.querySelectorAll('.btn-edit').forEach(btn => btn.onclick = () => handleEditMode(btn.dataset.id));
        }
        
        function renderVoucherList() {
            const listContainer = document.getElementById('voucher-list');
            listContainer.innerHTML = ''; 
            
            if (vouchers.length === 0) {
                listContainer.innerHTML = '<p>Belum ada voucher.</p>';
                return;
            }
            
            vouchers.forEach(voucher => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="item-info">
                        <h3>${voucher.code}</h3>
                        <span class="item-category">Disc: Rp ${formatRupiah(voucher.discountValue)}</span>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn btn-delete" data-id="${voucher.id}" data-collection="vouchers">Hapus</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            listContainer.querySelectorAll('.btn-delete').forEach(btn => btn.onclick = handleDelete);
        }
        
        // --- LOGIKA FORM ---

        function handleEditMode(id) {
            const product = products.find(p => p.id === id);
            if(!product) return;

            document.getElementById('menu-id').value = product.id;
            document.getElementById('menu-name').value = product.name;
            document.getElementById('menu-category').value = product.category;
            document.getElementById('menu-description').value = product.description || "";
            document.getElementById('menu-price').value = product.price;
            document.getElementById('menu-img').value = product.img;

            const saveBtn = document.getElementById('btn-save-menu');
            saveBtn.innerText = "Update Menu";
            saveBtn.classList.add('edit-mode');
            
            document.getElementById('form-title').innerText = "Edit Menu";
            document.getElementById('btn-cancel-edit').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetFormMenu() {
            document.getElementById('form-menu').reset();
            document.getElementById('menu-id').value = "";
            
            const saveBtn = document.getElementById('btn-save-menu');
            saveBtn.innerText = "Simpan Menu";
            saveBtn.classList.remove('edit-mode');
            
            document.getElementById('form-title').innerText = "Tambah Menu Baru";
            document.getElementById('btn-cancel-edit').style.display = "none";
        }

        async function handleSaveMenu(event) {
            event.preventDefault();
            const btn = document.getElementById('btn-save-menu');
            btn.disabled = true;

            const id = document.getElementById('menu-id').value;
            const data = {
                name: document.getElementById('menu-name').value,
                category: document.getElementById('menu-category').value,
                description: document.getElementById('menu-description').value,
                price: parseInt(document.getElementById('menu-price').value),
                img: document.getElementById('menu-img').value
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "products", id), data);
                    showStatus("Menu di-update!", true);
                } else {
                    data.isAvailable = true;
                    await addDoc(collection(db, "products"), data);
                    showStatus("Menu disimpan!", true);
                }
                resetFormMenu();
                await fetchProducts();
            } catch (e) {
                console.error(e);
                showStatus("Error: " + e.message, false);
            } finally {
                btn.disabled = false;
            }
        }
        
        async function handleAddVoucher(event) {
            event.preventDefault();
            document.getElementById('btn-add-voucher').disabled = true;
            const newVoucher = {
                code: document.getElementById('voucher-code-input').value.toUpperCase(),
                minTransaction: parseInt(document.getElementById('voucher-min').value),
                discountValue: parseInt(document.getElementById('voucher-discount').value),
            };
            try {
               await addDoc(collection(db, "vouchers"), newVoucher);
               showStatus("Voucher disimpan!", true);
               event.target.reset();
               await fetchVouchers();
            } catch (e) {
               showStatus("Error: " + e.message, false);
            } finally {
                document.getElementById('btn-add-voucher').disabled = false;
            }
        }
        
        async function handleDelete(event) {
            if (!confirm("Yakin hapus?")) return;
            const btn = event.target;
            try {
                await deleteDoc(doc(db, btn.dataset.collection, btn.dataset.id));
                showStatus("Item dihapus.", true);
                if (btn.dataset.collection === 'products') {
                    if(document.getElementById('menu-id').value === btn.dataset.id) resetFormMenu();
                    await fetchProducts();
                } else {
                    await fetchVouchers();
                }
            } catch (e) {
                showStatus("Gagal hapus.", false);
            }
        }
        
        async function handleToggleAvailability(event) {
            const btn = event.target;
            const currentStatus = btn.dataset.status === 'true';
            try {
                await updateDoc(doc(db, "products", btn.dataset.id), { isAvailable: !currentStatus });
                await fetchProducts();
                showStatus("Status diubah.", true);
            } catch (e) {
                showStatus("Gagal update status.", false);
            }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.nav-tab');
            const sections = document.querySelectorAll('.content-section');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`content-${tab.dataset.tab}`).classList.add('active');
                });
            });
            
            document.getElementById('form-menu').addEventListener('submit', handleSaveMenu);
            document.getElementById('btn-cancel-edit').addEventListener('click', resetFormMenu);
            document.getElementById('form-add-voucher').addEventListener('submit', handleAddVoucher);
            
            // Event Listener Search (Live Search)
            document.getElementById('search-input').addEventListener('input', renderMenuList);
            
            fetchData();
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Reservasi Dolan Sawah</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary: #2a9d8f;
      --primary-dark: #264653;
      --secondary: #e9c46a;
      --accent: #f4a261;
      --light: #f8f9fa;
      --dark: #333;
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding-bottom: 90px; /* Ruang untuk bottom bar */
      color: var(--dark);
    }

    header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: white;
      padding: 25px 20px;
      text-align: center;
      border-bottom-left-radius: 25px;
      border-bottom-right-radius: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 { margin: 0; font-size: 1.6rem; font-weight: 700; letter-spacing: 0.5px; }
    header p { margin: 5px 0 0; font-size: 0.9rem; opacity: 0.9; font-weight: 300; }

    .container { max-width: 600px; margin: -20px auto 0; padding: 15px; position: relative; z-index: 101; }

    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.02);
    }

    .section-title {
      font-size: 1.1rem;
      color: var(--primary-dark);
      margin-bottom: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    .section-title i { color: var(--accent); font-size: 1.2rem; }

    /* Form Styles */
    label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #555; font-weight: 500; }
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #eee;
      border-radius: 10px;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      margin-bottom: 15px;
      background: #fafafa;
      transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.1);
    }

    /* Location Cards */
    .location-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .location-option {
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      background: white;
    }
    .location-option.selected {
      border-color: var(--primary);
      background-color: rgba(42, 157, 143, 0.08);
    }
    .location-option.selected::after {
      content: '\f00c';
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      position: absolute;
      top: 5px; right: 5px;
      color: var(--primary);
      font-size: 0.8rem;
    }
    .location-option.disabled {
      opacity: 0.6;
      background-color: #f5f5f5;
      cursor: not-allowed;
      border-color: #e0e0e0;
    }
    .loc-name { font-weight: 700; display: block; margin-bottom: 5px; color: var(--primary-dark); }
    .loc-cap { font-size: 0.75rem; color: #888; display: block; }
    .loc-status { 
      font-size: 0.7rem; font-weight: 600; 
      display: inline-block; padding: 3px 8px; border-radius: 20px; margin-top: 8px; 
    }
    .status-ok { background: #d4edda; color: #155724; }
    .status-full { background: #f8d7da; color: #721c24; }

    /* Menu List */
    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-info h4 { margin: 0; font-size: 1rem; color: var(--dark); font-weight: 600; }
    .menu-info p { margin: 4px 0 0; font-size: 0.8rem; color: #888; line-height: 1.4; }
    
    .qty-control {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f8f9fa;
      padding: 5px 8px;
      border-radius: 25px;
      border: 1px solid #eee;
    }
    .qty-btn {
      width: 30px; height: 30px;
      border-radius: 50%;
      border: none;
      background: white;
      color: var(--primary);
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
      transition: transform 0.1s;
    }
    .qty-btn:active { transform: scale(0.9); }
    .qty-val { font-weight: 700; width: 20px; text-align: center; font-size: 1rem; color: var(--primary-dark); }

    /* Bottom Bar */
    .bottom-bar {
      position: fixed;
      bottom: 0; left: 0; width: 100%;
      background: white;
      padding: 15px 20px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
    }
    .total-info span { display: block; font-size: 0.8rem; color: #888; }
    .total-info strong { font-size: 1.1rem; color: var(--primary-dark); }
    
    .btn-book {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(42, 157, 143, 0.4);
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .btn-book:active { transform: scale(0.95); }
    .btn-book:hover { background-color: var(--primary-dark); }

    /* Loading Spinner */
    .loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: white; z-index: 2000;
      display: flex; justify-content: center; align-items: center;
      flex-direction: column;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <header>
    <h1><i class="fas fa-leaf"></i> Dolan Sawah</h1>
    <p>Formulir Reservasi Mandiri</p>
  </header>

  <div class="loader-overlay" id="loader">
    <div class="spinner"></div>
    <p style="color: #666; font-weight: 500;">Memuat Data...</p>
  </div>

  <div class="container">
    
    <div class="card">
      <div class="section-title"><i class="far fa-calendar-alt"></i> Waktu Kunjungan</div>
      <label>Tanggal Rencana Datang</label>
      <input type="date" id="inputDate" onchange="checkAvailability()">
      
      <div style="display: flex; gap: 15px;">
        <div style="flex:1">
            <label>Jam</label>
            <input type="time" id="inputTime">
        </div>
        <div style="flex:1">
            <label>Jumlah Orang</label>
            <input type="number" id="inputPax" min="1" value="2" onchange="checkAvailability()">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-map-marker-alt"></i> Pilih Tempat Duduk</div>
      <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px; background: #e3f2fd; padding: 10px; border-radius: 8px; border-left: 4px solid #2196f3;">
        <i class="fas fa-info-circle"></i> Sistem otomatis mengecek ketersediaan kursi di tanggal yang Anda pilih.
      </p>
      <div class="location-grid" id="locationList">
        <p style="grid-column: span 2; text-align: center; color: #999; padding: 20px;">Silakan pilih tanggal terlebih dahulu.</p>
      </div>
      <input type="hidden" id="selectedLocation">
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-utensils"></i> Pilih Menu (Pre-Order)</div>
      <div id="menuList">
        </div>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-user-edit"></i> Data Pemesan</div>
      <label>Nama Lengkap</label>
      <input type="text" id="inputName" placeholder="Contoh: Budi Santoso">
      
      <label>Nomor WhatsApp (Aktif)</label>
      <input type="tel" id="inputPhone" placeholder="Contoh: 081234567890">
      <small style="display:block; margin-top:-10px; margin-bottom:15px; color:#888; font-size:0.75rem;">Kami akan menghubungi nomor ini untuk konfirmasi.</small>
      
      <label>Catatan Tambahan (Opsional)</label>
      <textarea id="inputNote" rows="2" placeholder="Contoh: Butuh kursi bayi, alergi kacang, dll."></textarea>
    </div>

  </div>

  <div class="bottom-bar">
    <div class="total-info">
      <span id="totalItems">0 Menu Dipilih</span>
      <strong id="statusText">Siap Booking?</strong>
    </div>
    <button class="btn-book" onclick="submitReservation()">
      Kirim Request <i class="fas fa-paper-plane"></i>
    </button>
  </div>

  <script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
      authDomain: "reservasi-dolan-sawah.firebaseapp.com",
      projectId: "reservasi-dolan-sawah",
      storageBucket: "reservasi-dolan-sawah.appspot.com",
      messagingSenderId: "213151400721",
      appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- VARIABEL GLOBAL ---
    let locationsData = [];
    let menusData = {};
    let selectedMenus = {}; 
    let selectedLocationName = "";

    // --- INISIALISASI ---
    document.addEventListener('DOMContentLoaded', async () => {
      // Set min date ke hari ini
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('inputDate').setAttribute('min', today);
      
      await loadData();
      document.getElementById('loader').style.display = 'none';
    });

    // --- 1. LOAD DATA DARI FIREBASE ---
    async function loadData() {
      try {
        // Load Locations (Pastikan nama koleksi 'locations' atau 'Locations' sesuai database)
        // Gunakan try-catch per collection agar tidak blank semua jika salah satu gagal
        try {
            const locSnapshot = await db.collection('locations').get(); // Cek huruf besar/kecil di sini
            locationsData = [];
            locSnapshot.forEach(doc => {
                locationsData.push({ id: doc.id, ...doc.data() });
            });
        } catch (e) {
            console.warn("Gagal load lokasi, coba pakai huruf kapital 'Locations'...", e);
            const locSnapshot = await db.collection('Locations').get(); 
            locationsData = [];
            locSnapshot.forEach(doc => {
                locationsData.push({ id: doc.id, ...doc.data() });
            });
        }

        // Load Menus
        try {
            const menuSnapshot = await db.collection('menus').get();
            menusData = {};
            menuSnapshot.forEach(doc => {
                menusData[doc.id] = doc.data().details || [];
            });
        } catch (e) {
             console.warn("Gagal load menu", e);
        }

        renderMenu();
      } catch (error) {
        console.error("Error loading data:", error);
        Swal.fire('Koneksi Bermasalah', 'Gagal memuat data. Pastikan internet lancar atau hubungi admin.', 'error');
      }
    }

    // --- 2. LOGIKA KETERSEDIAAN TEMPAT ---
    async function checkAvailability() {
      const dateVal = document.getElementById('inputDate').value;
      const paxVal = parseInt(document.getElementById('inputPax').value) || 1;
      
      if (!dateVal) return;

      const locContainer = document.getElementById('locationList');
      locContainer.innerHTML = '<p style="grid-column: span 2; text-align: center; padding:20px; color:var(--primary);"><i class="fas fa-spinner fa-spin"></i> Sedang mengecek kapasitas...</p>';

      try {
        // Kita tetap mengecek koleksi 'reservations' (yang sudah diapprove)
        // Agar tamu tidak memesan tempat yang sudah fix penuh.
        const snapshot = await db.collection('reservations')
          .where('date', '==', dateVal)
          .get();

        const usageMap = {}; 

        snapshot.forEach(doc => {
          const r = doc.data();
          if (r.tempat) {
            usageMap[r.tempat] = (usageMap[r.tempat] || 0) + (parseInt(r.jumlah) || 0);
          }
        });

        // Render Lokasi
        locContainer.innerHTML = '';
        
        if (locationsData.length === 0) {
             locContainer.innerHTML = '<p style="color:red; text-align:center;">Data lokasi tidak ditemukan.</p>';
             return;
        }

        locationsData.sort((a,b) => a.name.localeCompare(b.name)).forEach(loc => {
          const used = usageMap[loc.name] || 0;
          const capacity = loc.capacity;
          const remaining = capacity - used;
          const isFull = remaining < paxVal; 

          const div = document.createElement('div');
          div.className = `location-option ${isFull ? 'disabled' : ''}`;
          if (selectedLocationName === loc.name && !isFull) div.classList.add('selected');

          div.innerHTML = `
            <span class="loc-name">${loc.name}</span>
            <span class="loc-cap">Kapasitas: ${capacity} org</span>
            <span class="loc-status ${isFull ? 'status-full' : 'status-ok'}">
              ${isFull ? 'PENUH' : `Tersedia: ${remaining} kursi`}
            </span>
          `;

          if (!isFull) {
            div.onclick = () => selectLocation(loc.name, div);
          } else {
            div.onclick = () => Swal.fire('Tempat Penuh', `Maaf, tempat ${loc.name} tidak cukup untuk ${paxVal} orang di tanggal ini.`, 'warning');
          }

          locContainer.appendChild(div);
        });

      } catch (error) {
        console.error(error);
        locContainer.innerHTML = '<p style="color:red; text-align:center;">Gagal mengecek ketersediaan. (Cek console)</p>';
      }
    }

    function selectLocation(name, element) {
      selectedLocationName = name;
      document.getElementById('selectedLocation').value = name;
      
      // Visual Feedback
      document.querySelectorAll('.location-option').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
    }

    // --- 3. RENDER & LOGIKA MENU ---
    function renderMenu() {
      const container = document.getElementById('menuList');
      container.innerHTML = '';

      if (Object.keys(menusData).length === 0) {
          container.innerHTML = '<p style="text-align:center; padding:10px;">Menu sedang dimuat atau kosong.</p>';
          return;
      }

      Object.keys(menusData).sort().forEach(menuName => {
        const details = menusData[menuName].join(', '); 
        
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.innerHTML = `
          <div class="menu-info">
            <h4>${menuName}</h4>
            <p>${details.substring(0, 60)}${details.length > 60 ? '...' : ''}</p>
          </div>
          <div class="qty-control">
            <button class="qty-btn" onclick="updateQty('${menuName}', -1)">-</button>
            <span class="qty-val" id="qty-${menuName.replace(/[^a-zA-Z0-9]/g, '-')}" data-name="${menuName}">0</span>
            <button class="qty-btn" onclick="updateQty('${menuName}', 1)">+</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function updateQty(name, change) {
      const safeId = name.replace(/[^a-zA-Z0-9]/g, '-');
      const current = selectedMenus[name] || 0;
      const newVal = current + change;
      
      if (newVal < 0) return;
      
      if (newVal === 0) {
        delete selectedMenus[name];
      } else {
        selectedMenus[name] = newVal;
      }

      // Update UI Angka
      const el = document.getElementById(`qty-${safeId}`);
      if(el) el.textContent = newVal;

      updateBottomBar();
    }

    function updateBottomBar() {
      const count = Object.values(selectedMenus).reduce((a, b) => a + b, 0);
      document.getElementById('totalItems').textContent = `${count} Menu Dipilih`;
      
      const btn = document.querySelector('.btn-book');
      if (count > 0 && selectedLocationName && document.getElementById('inputDate').value) {
          document.getElementById('statusText').textContent = "Data Lengkap";
          btn.style.opacity = "1";
      } else {
          document.getElementById('statusText').textContent = "Lengkapi Data";
      }
    }

    // --- 4. SUBMIT RESERVASI (MODIFIKASI UTAMA) ---
    async function submitReservation() {
      // Validasi Input
      const date = document.getElementById('inputDate').value;
      const time = document.getElementById('inputTime').value;
      const pax = parseInt(document.getElementById('inputPax').value);
      const name = document.getElementById('inputName').value.trim();
      const phone = document.getElementById('inputPhone').value.trim();
      const note = document.getElementById('inputNote').value.trim();
      
      if (!date || !time || !pax || !name || !phone) {
        Swal.fire('Data Belum Lengkap', 'Mohon lengkapi tanggal, jam, jumlah orang, nama, dan nomor HP.', 'warning');
        return;
      }

      if (!selectedLocationName) {
        Swal.fire('Tempat Belum Dipilih', 'Silakan pilih tempat duduk yang tersedia di Step 2.', 'warning');
        return;
      }

      if (Object.keys(selectedMenus).length === 0) {
        Swal.fire('Menu Belum Dipilih', 'Silakan pilih minimal 1 menu.', 'warning');
        return;
      }

      // Format Data Menu
      const menuArray = Object.entries(selectedMenus).map(([key, val]) => ({
        name: key,
        quantity: val
      }));

      // --- PERUBAHAN DATA DISINI ---
      const reservationData = {
        date: date,
        jam: time,
        jumlah: pax,
        nama: name,
        nomorHp: cleanPhoneNumber(phone),
        tempat: selectedLocationName,
        tambahan: note,
        menus: menuArray,
        dp: 0, 
        tipeDp: '',
        via: 'Website Mandiri',
        status: 'pending', // Menandakan perlu persetujuan admin
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      Swal.fire({
        title: 'Mengirim Permintaan...',
        text: 'Mohon tunggu sebentar, jangan tutup halaman.',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        // SIMPAN KE KOLEKSI 'reservation_requests' (RUANG TUNGGU)
        await db.collection('reservation_requests').add(reservationData);
        
        Swal.fire({
          icon: 'success',
          title: 'Permintaan Terkirim!',
          html: `
            <div style="text-align:left; font-size:0.95rem;">
                <p>Halo <b>${name}</b>, permintaan reservasi Anda telah kami terima.</p>
                <p>Status saat ini: <span style="background:orange; color:white; padding:2px 8px; border-radius:10px;">Menunggu Konfirmasi</span></p>
                <p>Admin kami akan mengecek ketersediaan dan segera menghubungi Anda via WhatsApp jika disetujui.</p>
                <p style="margin-top:10px; font-weight:bold;">Terima Kasih!</p>
            </div>
          `,
          confirmButtonText: 'Oke, Saya Tunggu',
          confirmButtonColor: 'var(--primary)'
        }).then(() => {
            window.location.reload(); // Refresh agar form bersih kembali
        });

      } catch (error) {
        console.error("Submit Error:", error);
        Swal.fire('Gagal Mengirim', 'Terjadi kesalahan sistem atau izin ditolak. Silakan coba lagi atau hubungi admin.', 'error');
      }
    }

    function cleanPhoneNumber(phone) {
      let p = phone.replace(/[^0-9]/g, '');
      if (p.startsWith('0')) p = '62' + p.substring(1); // Format ke 62
      return p;
    }

  </script>
</body>
</html>
